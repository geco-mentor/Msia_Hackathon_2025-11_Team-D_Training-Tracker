name: Participation Tracker

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]
  discussion:
    types: [created]

concurrency:
  group: leaderboard-update
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  update-leaderboard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Update Leaderboard
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const POINTS = {
              issue: 5,
              pull_request: 10,
              discussion: 5
            };

            const type = context.eventName;
            const user = context.actor;

            if (user.includes('[bot]')) return;

            let pointsToAdd = 0;
            if (type === 'issues') pointsToAdd = POINTS.issue;
            if (type === 'pull_request') pointsToAdd = POINTS.pull_request;
            if (type === 'discussion') pointsToAdd = POINTS.discussion;

            console.log(`Processing: ${user} gained ${pointsToAdd} points for ${type}`);

            let data = {};
            const dataFile = '.github/leaderboard_data.json';

            try {
              if (fs.existsSync(dataFile)) {
                data = JSON.parse(fs.readFileSync(dataFile, 'utf8'));
              }
            } catch (err) {
              console.log("Creating new data file...");
            }

            if (!data[user]) {
              data[user] = { score: 0, contributions: 0 };
            }
            data[user].score += pointsToAdd;
            data[user].contributions += 1;

            fs.writeFileSync(dataFile, JSON.stringify(data, null, 2));

            const sortedUsers = Object.entries(data).sort((a, b) => b[1].score - a[1].score);
            let mdContent = "# ğŸ† Community Leaderboard\n\n";
            mdContent += "| Rank | User | Contributions | Score |\n";
            mdContent += "|---|---|---|---|\n";
            sortedUsers.forEach(([username, stats], index) => {
              const rank = index + 1;
              let medal = "";
              if (rank === 1) medal = "ğŸ¥‡ ";
              if (rank === 2) medal = "ğŸ¥ˆ ";
              if (rank === 3) medal = "ğŸ¥‰ ";

              mdContent += `| ${rank} | ${medal}@${username} | ${stats.contributions} | **${stats.score}** |\n`;
            });
            mdContent += "\n\n*Updated automatically by GitHub Actions*";

            fs.writeFileSync('LEADERBOARD.md', mdContent);

      - name: Commit and Push Changes
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name || 'main' }}
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add .github/leaderboard_data.json LEADERBOARD.md
          git commit -m "ğŸ† Update Leaderboard for ${{ github.actor }}" || exit 0
          git push origin HEAD:$BRANCH_NAME
