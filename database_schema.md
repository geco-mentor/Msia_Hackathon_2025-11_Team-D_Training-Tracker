# Supabase Database Schema

Based on your project's current codebase and implementation, here is the updated and verified database schema for Supabase (PostgreSQL).

## Overview

We use 7 main tables to map your data:

1.  **jobs**: Stores job titles and their specific skill requirements.
2.  **employees**: Stores employee profiles, including their stats, job title, department, skill profiles, and gamification progress.
3.  **admins**: Stores admin profiles.
4.  **scenarios**: Stores the training scenarios (CTF challenges), including personalized challenges generated by AI.
5.  **assessments**: Stores the history of completed scenarios by employees, including AI evaluations.
6.  **goals**: Stores employee learning goals.
7.  **departments**: Stores department info including department-specific rubrics.
8.  **general_rubrics**: Stores static generic rubrics (same for all assessments).

## SQL Setup

You can run the following SQL in your Supabase **SQL Editor** to create the tables.

```sql
-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- 1. Jobs Table
create table if not exists public.jobs (
  id uuid primary key default uuid_generate_v4(),
  title text not null unique,
  description text,
  required_skills jsonb default '[]'::jsonb,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Employees Table
create table if not exists public.employees (
  id uuid primary key default uuid_generate_v4(),
  name text not null,
  username text not null unique,
  employee_id text unique,
  password_hash text not null,
  job_id uuid references public.jobs(id) on delete set null,
  job_title text, -- Denormalized or fallback
  department text,
  ranking int default 0,
  win_rate float default 0.0,
  streak int default 0,
  skills_profile jsonb default '{}'::jsonb,
  total_points int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Admins Table
create table if not exists public.admins (
  id uuid primary key default uuid_generate_v4(),
  name text,
  username text not null unique,
  password_hash text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. Scenarios (CTF Challenges) Table
create table if not exists public.scenarios (
  id uuid primary key default uuid_generate_v4(),
  title text,
  category text,
  skill text,
  difficulty text,
  scenario_text text,
  task text,
  type text, -- 'text' or 'multiple_choice'
  options jsonb, -- Array of options if multiple_choice
  rubric jsonb,
  hint text,
  is_personalized boolean default false,
  creator_id uuid references public.employees(id) on delete set null,
  source_file text, -- S3 key of the original uploaded file
  extracted_text_file text, -- S3 key of the extracted text file
  department_id uuid references public.departments(id) on delete set null,
  post_assessment_date timestamp with time zone,
  status text default 'draft', -- 'draft', 'published', etc.
  solves int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. Assessments (Submissions) Table
create table if not exists public.assessments (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade,
  scenario_id uuid references public.scenarios(id) on delete cascade,
  score int,
  feedback text,
  user_response text,
  difficulty text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 6. Goals Table
create table if not exists public.goals (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade,
  description text not null,
  completed boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 7. Leaderboard View
create or replace view public.leaderboard as
select 
  id as user_id,
  username,
  total_points,
  department,
  rank() over (order by total_points desc) as rank
from public.employees;

-- 8. RPC Function for incrementing solves
create or replace function increment_solves(row_id uuid)
returns void as $$
begin
  update public.scenarios
  set solves = coalesce(solves, 0) + 1
  where id = row_id;
end;
$$ language plpgsql;
```

## Typescript Interface Mapping

*   **Job**: Maps to `jobs` table.
*   **Employee**: Maps to `employees` table.
*   **Admin**: Maps to `admins` table.
*   **Scenario**: Maps to `scenarios` table. Includes `is_personalized` and `creator_id` for AI-generated quests.
*   **Assessment**: Maps to `assessments` table.
*   **Goal**: Maps to `goals` table.
