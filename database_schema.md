# Supabase Database Schema

Based on your project's TypeScript interfaces and the latest feature requirements (FEATURES.md), here is the updated database schema for Supabase (PostgreSQL).

## Overview

We will use 8 main tables to map your data:

1.  **jobs**: Stores job titles and their specific skill requirements (Basic GenAI skills).
2.  **employees**: Stores employee profiles, including their stats, job title, department, skill profiles, and gamification progress.
3.  **admins**: Stores admin profiles.
4.  **scenarios**: Stores the training scenarios (CTF challenges), including the rubric (as JSON).
5.  **assessments**: Stores the history of completed scenarios by employees.
6.  **goals**: Stores employee goals.
7.  **achievements**: Stores available badges and milestones.
8.  **user_achievements**: Links employees to their earned achievements.

## SQL Setup

You can run the following SQL in your Supabase **SQL Editor** to create the tables.

```sql
-- Enable UUID extension if not already enabled
create extension if not exists "uuid-ossp";

-- 1. Jobs Table (New)
create table public.jobs (
  id uuid primary key default uuid_generate_v4(),
  title text not null unique, -- e.g., "Software Engineer", "Marketing Specialist"
  description text,
  required_skills jsonb default '[]'::jsonb, -- Array of strings: ["Prompt Engineering", "Summarization"]
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Admins Table
create table public.admins (
  id uuid primary key default uuid_generate_v4(),
  name text not null,
  username text unique not null,
  password_hash text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Employees Table (Enhanced)
create table public.employees (
  id uuid primary key default uuid_generate_v4(),
  name text not null,
  username text unique not null,
  employee_id text unique not null,
  password_hash text not null,
  
  -- Job & Department
  job_id uuid references public.jobs(id) on delete set null,
  job_title text, -- Kept for display/fallback, or sync with jobs.title
  department text, -- e.g., "Engineering", "Sales" (For team-level insights)
  
  -- Skills & Stats
  skills_profile jsonb default '{}'::jsonb, -- Stores { "Empathy": 80, "Active Listening": 70 }
  ranking int default 0,      -- Global rank
  win_rate float default 0.0,
  streak int default 0,
  
  -- CTF / Gamification
  total_points int default 0, -- Sum of points from completed challenges
  level int default 1,        -- Calculated level based on points
  
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. Scenarios Table (CTF Challenges)
create table public.scenarios (
  id uuid primary key default uuid_generate_v4(),
  
  -- Metadata
  title text, -- Short title (e.g., "Injection 101")
  skill text not null, -- The primary skill tested (e.g. "Prompt Engineering")
  difficulty text check (difficulty in ('Easy', 'Normal', 'Hard', 'Expert')) not null,
  points int default 10, -- Points awarded for completion
  
  -- Content
  scenario_text text not null, -- The micro-scenario (1-3 sentences)
  task text not null, -- Specific instruction for the user
  hint text, -- Optional hint to encourage learning
  
  -- Type & Validation
  type text check (type in ('text', 'multiple_choice', 'code')) default 'text',
  options jsonb, -- For multiple_choice: ["Option A", "Option B"]
  rubric jsonb not null, -- AI evaluation criteria (relevance, accuracy, reasoning, safety)
  
  -- Settings
  time_limit int, -- Optional: seconds to complete
  is_active boolean default true,
  
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. Assessments Table (History & Scoring)
create table public.assessments (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade not null,
  scenario_id uuid references public.scenarios(id) on delete set null,
  
  -- Results
  score int not null, -- 0-100 (AI evaluated)
  points_awarded int default 0, -- Actual points given
  feedback text, -- AI generated personalized feedback
  user_response text,
  difficulty text, -- Snapshot of difficulty at time of attempt
  
  -- Metadata
  attempts int default 1,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 6. Goals Table
create table public.goals (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade not null,
  description text not null, -- Actionable task generated by AI
  completed boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 7. Achievements Table
create table public.achievements (
  id uuid primary key default uuid_generate_v4(),
  name text not null, -- e.g., "First Blood", "Prompt Master"
  description text not null,
  icon text, -- URL or icon name
  criteria jsonb, -- Logic for awarding (e.g., { "min_points": 100 })
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 8. User Achievements Table
create table public.user_achievements (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade not null,
  achievement_id uuid references public.achievements(id) on delete cascade not null,
  earned_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(user_id, achievement_id)
);

-- 9. Leaderboard View
create or replace view public.leaderboard as
select 
  id as user_id,
  username,
  total_points,
  department,
  rank() over (order by total_points desc) as rank
from public.employees;
```

## Typescript Interface Mapping

*   **Job**: Maps to `jobs` table.
*   **Employee**: Maps to `employees` table. Now includes `department` and `job_id`.
*   **Admin**: Maps to `admins` table.
*   **Scenario**: Maps to `scenarios` table.
*   **HistoryItem**: Maps to a row in `assessments`.
*   **Goal**: Maps to `goals` table.
*   **Achievement**: Maps to `achievements` table.
