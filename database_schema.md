# Supabase Database Schema

Based on your project's current codebase and implementation, here is the updated and verified database schema for Supabase (PostgreSQL).

## Overview

We use 7 main tables to map your data:

1.  **jobs**: Stores job titles and their specific skill requirements.
2.  **employees**: Stores employee profiles, including their stats, job title, department, skill profiles, and gamification progress.
3.  **admins**: Stores admin profiles.
4.  **scenarios**: Stores the training scenarios (CTF challenges), including personalized challenges generated by AI.
5.  **assessments**: Stores the history of completed scenarios by employees, including AI evaluations.
6.  **goals**: Stores employee learning goals.
7.  **departments**: Stores department info including department-specific rubrics.
8.  **general_rubrics**: Stores static generic rubrics (same for all assessments).
9.  **pre_assessments**: Tracks employee pre-assessment completion (familiarity check + baseline questions).

## SQL Setup

You can run the following SQL in your Supabase **SQL Editor** to create the tables.

```sql
-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- 1. Jobs Table
create table if not exists public.jobs (
  id uuid primary key default uuid_generate_v4(),
  title text not null unique,
  description text,
  required_skills jsonb default '[]'::jsonb,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Employees Table
create table if not exists public.employees (
  id uuid primary key default uuid_generate_v4(),
  name text not null,
  username text not null unique,
  employee_id text unique,
  password_hash text not null,
  job_id uuid references public.jobs(id) on delete set null,
  job_title text, -- Denormalized or fallback
  job_description text, -- AI-generated or user-provided
  department text,
  ranking int default 0,
  win_rate float default 0.0,
  streak int default 0,
  skills_profile jsonb default '{}'::jsonb,
  total_points int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Admins Table
create table if not exists public.admins (
  id uuid primary key default uuid_generate_v4(),
  name text,
  username text not null unique,
  password_hash text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. Scenarios (CTF Challenges) Table
create table if not exists public.scenarios (
  id uuid primary key default uuid_generate_v4(),
  title text,
  category text,
  skill text,
  difficulty text,
  scenario_text text,
  task text,
  type text, -- 'text' or 'multiple_choice'
  options jsonb, -- Array of options if multiple_choice
  rubric jsonb,
  hint text,
  is_personalized boolean default false,
  creator_id uuid references public.employees(id) on delete set null,
  source_file text, -- S3 key of the original uploaded file
  extracted_text_file text, -- S3 key of the extracted text file
  department_id uuid references public.departments(id) on delete set null, -- DEPRECATED: Use department_ids instead
  department_ids uuid[] default '{}', -- Array of department IDs this training is for
  post_assessment_date timestamp with time zone,
  status text default 'draft', -- 'draft', 'published', etc.
  solves int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. Assessments (Submissions) Table
create table if not exists public.assessments (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade,
  scenario_id uuid references public.scenarios(id) on delete cascade,
  score int,
  feedback text,
  user_response text,
  difficulty text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 6. Goals Table
create table if not exists public.goals (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade,
  description text not null,
  completed boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 7. Departments Table
create table if not exists public.departments (
  id uuid primary key default gen_random_uuid(),
  name text not null unique,
  rubrics text[] default '{}',  -- Array of department-specific evaluation criteria
  created_at timestamp with time zone default now()
);

-- 8. General Rubrics Table (Static generic criteria for all assessments)
create table if not exists public.general_rubrics (
  id uuid primary key default gen_random_uuid(),
  name text not null unique,
  description text,
  display_order integer default 0,
  created_at timestamp with time zone default now()
);

-- Initial Generic Rubrics Data
INSERT INTO general_rubrics (name, description, display_order) VALUES
  ('Communication', 'Ability to clearly express ideas', 1),
  ('Critical Thinking', 'Ability to analyze and evaluate information', 2),
  ('Problem Solving', 'Ability to identify and resolve issues', 3)
ON CONFLICT (name) DO NOTHING;

-- Department Rubrics Data
UPDATE departments SET rubrics = ARRAY['Sales Strategy', 'Customer Focus', 'Revenue Generation'] WHERE LOWER(name) = 'sales';
UPDATE departments SET rubrics = ARRAY['Technical Excellence', 'Innovation', 'System Design'] WHERE LOWER(name) = 'engineering';
UPDATE departments SET rubrics = ARRAY['Financial Analysis', 'Risk Management', 'Compliance'] WHERE LOWER(name) = 'finance';
UPDATE departments SET rubrics = ARRAY['Employee Relations', 'Policy Knowledge', 'Talent Management'] WHERE LOWER(name) = 'hr';
UPDATE departments SET rubrics = ARRAY['Brand Awareness', 'Campaign Strategy', 'Market Analysis'] WHERE LOWER(name) = 'marketing';

-- 7. Leaderboard View
create or replace view public.leaderboard as
select 
  id as user_id,
  username,
  total_points,
  department,
  rank() over (order by total_points desc) as rank
from public.employees;

-- 8. RPC Function for incrementing solves
create or replace function increment_solves(row_id uuid)
returns void as $$
begin
  update public.scenarios
  set solves = coalesce(solves, 0) + 1
  where id = row_id;
end;
$$ language plpgsql;

-- 9. Pre-Assessments Table (tracks employee familiarity check and baseline)
create table if not exists public.pre_assessments (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade not null,
  scenario_id uuid references public.scenarios(id) on delete cascade not null,
  is_familiar boolean default false,
  questions_asked jsonb default '[]'::jsonb,  -- Array of micro-scenarios with question, type, options, hint
  answers_given jsonb default '[]'::jsonb,    -- Array of answers with score, feedback
  baseline_score int default 0,
  current_difficulty text default 'Easy',      -- Adaptive: Easy, Normal, Hard
  personalized_feedback jsonb,                 -- AI-generated feedback at completion
  completed boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  completed_at timestamp with time zone,
  unique(user_id, scenario_id)
);

-- 10. Course Ratings Table (star ratings and reviews for courses)
create table if not exists public.course_ratings (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade not null,
  scenario_id uuid references public.scenarios(id) on delete cascade not null,
  rating integer not null check (rating >= 1 and rating <= 5),
  review text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(user_id, scenario_id)
);

-- 11. Career Paths Table (progression tracks for employees)
create table if not exists public.career_paths (
  id uuid primary key default uuid_generate_v4(),
  name text not null,
  description text,
  department text,
  levels jsonb default '[]'::jsonb,  -- Array of {level, title, required_trainings[], min_elo}
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 12. Update Employees table for career tracking and manager flag
alter table employees add column if not exists career_path_id uuid references public.career_paths(id);
alter table employees add column if not exists career_level integer default 1;
alter table employees add column if not exists is_manager boolean default false;
alter table employees add column if not exists manager_id uuid references public.employees(id);

-- Sample Career Paths Data
INSERT INTO career_paths (name, description, department, levels) VALUES
  ('Software Engineering', 'Technical career track for engineers', 'Engineering', '[
    {"level": 1, "title": "Junior Engineer", "required_trainings": [], "min_elo": 800},
    {"level": 2, "title": "Mid Engineer", "required_trainings": ["Technical Excellence"], "min_elo": 1000},
    {"level": 3, "title": "Senior Engineer", "required_trainings": ["System Design", "Innovation"], "min_elo": 1200},
    {"level": 4, "title": "Staff Engineer", "required_trainings": ["Architecture", "Leadership"], "min_elo": 1400},
    {"level": 5, "title": "Principal Engineer", "required_trainings": ["Strategy", "Mentorship"], "min_elo": 1600}
  ]'::jsonb),
  ('Sales Professional', 'Sales career progression track', 'Sales', '[
    {"level": 1, "title": "Sales Associate", "required_trainings": [], "min_elo": 800},
    {"level": 2, "title": "Sales Executive", "required_trainings": ["Sales Strategy"], "min_elo": 1000},
    {"level": 3, "title": "Senior Account Manager", "required_trainings": ["Customer Focus", "Revenue Generation"], "min_elo": 1200},
    {"level": 4, "title": "Sales Manager", "required_trainings": ["Leadership", "Team Management"], "min_elo": 1400}
  ]'::jsonb),
  ('Finance Professional', 'Finance and accounting career track', 'Finance', '[
    {"level": 1, "title": "Financial Analyst", "required_trainings": [], "min_elo": 800},
    {"level": 2, "title": "Senior Analyst", "required_trainings": ["Financial Analysis"], "min_elo": 1000},
    {"level": 3, "title": "Finance Manager", "required_trainings": ["Risk Management", "Compliance"], "min_elo": 1200},
    {"level": 4, "title": "Finance Director", "required_trainings": ["Strategy", "Leadership"], "min_elo": 1400}
  ]'::jsonb)
ON CONFLICT DO NOTHING;
-- 13. Employee Certifications Table (employees add their own certificates)
create table if not exists public.employee_certifications (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade not null,
  name text not null,
  issuer text,
  issue_date date,
  expiry_date date,
  credential_id text,
  credential_url text,
  description text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 14. Employee Career Goals Table (career aspirations with AI roadmaps)
create table if not exists public.employee_career_goals (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid references public.employees(id) on delete cascade not null,
  goal_title text not null,
  goal_description text,
  target_timeframe text default '5 years',
  generated_roadmap jsonb,
  recommended_certifications text[] default '{}',
  recommended_assessments text[] default '{}',
  status text default 'active',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);
```

## Typescript Interface Mapping

*   **Job**: Maps to `jobs` table.
*   **Employee**: Maps to `employees` table.
*   **Admin**: Maps to `admins` table.
*   **Scenario**: Maps to `scenarios` table. Includes `is_personalized` and `creator_id` for AI-generated quests.
*   **Assessment**: Maps to `assessments` table.
*   **Goal**: Maps to `goals` table.
